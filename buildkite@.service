[Unit]
Description=BuildKite Agent
After=docker.service
Requires=docker.service

[Service]
EnvironmentFile=/etc/environment
TimeoutStartSec=0
TimeoutStopSec=0

Environment=DOCKER_REPO=quay.io/democracyworks/buildkite-agent
Environment=VERSION=1.0-beta.21-docker-1.5.0
Environment=CONTAINER=buildkite-agent

ExecStartPre=-/usr/bin/docker kill ${CONTAINER}
ExecStartPre=-/usr/bin/docker rm ${CONTAINER}
ExecStartPre=/usr/bin/docker pull ${DOCKER_REPO}:${VERSION}

ExecStart=/bin/bash -c 'docker run --name ${CONTAINER} \
  --env BUILDBOX_AGENT_TOKEN=$(curl -s http://${COREOS_PRIVATE_IPV4}:8500/v1/kv/buildkite/agent-token?raw) \
  --env DOCKERCFG=$(curl -s http://${COREOS_PRIVATE_IPV4}:8500/v1/kv/buildkite/dockercfg?raw) \
  --volume /usr/bin/docker:/usr/bin/docker --volume /var/run/docker.sock:/var/run/docker.sock \
  ${DOCKER_REPO}:${VERSION}'

# USR2 will tell the agent to wrap up any currently-running builds and then shutdown
ExecStop=/usr/bin/docker kill -s USR2 ${CONTAINER}

[X-Fleet]
Conflicts=buildkite@*.service
